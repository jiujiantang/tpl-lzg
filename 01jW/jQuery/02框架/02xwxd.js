// ???????????,??????????
// window:????????,???????
// undefined:?????????????????????????????????js???????????????????????????¦Â?undefined.
// ??§Õ??¦Â?,undefined?????,???§Ø????????false
(function(window,undefined){
    // ????:???????push??????????????push ????:[].push()?????push() ???:??????????????????
    // ???????? -> var push = function {};
    var push = [].push;
    // ???????????
    function wxd (html) {
        // new?????????????????????????????????????????????????????????????????????????
        return new wxd.fn.init( html );
    }
    // ????????????????fn????
    wxd.fn = wxd.prototype = {
        // ????????????
        constructor: wxd,
        // ..?
        length: 0,
        // ?????????
        init: function(html){
            if(html == null || html ===''){
                // ????
                return;
            }
            if (typeof html === 'function'){
                // body...
            }
            if ( wxd.isString){
                if(/^</.test(html)){
                    // ?????????????????Dom?????????????,???push?????????
                    push.apply( this, parseHTML(html));
                }else {
                    // 01????????
                    push.apply( this,wxd.select(html) );
                }
            }
        }
    }
    // wxd.fn.init.prototype = wxd.fn = wxd.prototype
    // ??init????????????????wxd???????????
    wxd.fn.init.prototype = wxd.fn;

    ///////////////////// ???select????????///////////////////////////////////
    var select = (function () {
        var push = [].push;
        // ??????????????????????§Õ push
        try {
            var div = document.createElement( 'div' );
            div.innerHTML = '<p></p>';
            var arr = [];
            push.apply( arr, div.getElementsByTagName( 'p' ));
        } catch ( e ) {

            push = {
                apply: function ( array1, array2 ) {
                    for ( var i = 0; i < array2.length; i++ ) {
                        array1[ array1.length++ ] = array2[ i ];
                    }
                }
            };
        }



        // ???????
        var rnative = /\{\s*\[native/;
        var rtrim = /^\s+|\s+$/g;
//                          1           2         3     4
        var rbaseselector = /^(?:\#([\w\-]+)|\.([\w\-]+)|(\*)|(\w+))$/;






        // ????????, support ????, ??? qsa ?? byclass
        var support = {};

        support.qsa = rnative.test( document.querySelectorAll + '' );
        support.getElementsByClassName =
            rnative.test( document.getElementsByClassName + '' );
        support.trim = rnative.test( String.prototype.trim + '' );
        support.indexOf = rnative.test( Array.prototype.indexOf + '' );






        // ????????
        function getByClassName ( className, node ) {
            node = node || document;
            var allElem, res = [], i;

            if ( support.getElementsByClassName ) {
                return node.getElementsByClassName( className );
            } else {
                allElem = node.getElementsByTagName( '*' );
                for ( i = 0; i < allElem.length; i++ ) {
                    if ( allElem[ i ].className === className ) {
                        res.push( allElem[ i ] );
                    }
                }
                return res;
            }
        }

        // ???????? trim ????
        var myTrim = function ( str ) {
            // ???????????, ?????????????
            if ( support.trim ) {
                return str.trim();
            } else {
                // ????????
                return str.replace( rtrim, '' );
            }
        }

        var myIndexOf = function ( array, search, startIndex ) {
            startIndex = startIndex || 0;
            if ( support.indexOf ) {
                return array.indexOf( search, startIndex );
            } else {
                for ( var i = startIndex; i < array.length; i++ ) {
                    if ( array[ i ] === search ) {
                        return i;
                    }
                }
                return -1;
            }
        }


        var unique = function ( array ) {
            var resArray = [], i = 0;
            for ( ; i < array.length; i++ ) {
                if ( myIndexOf( resArray, array[ i ] ) == -1 ) {
                    resArray.push( array[ i ] );
                }
            }
            return resArray;
        }


        function basicSelect ( selector, node ) {
            node = node || document;
            var m, res;
            if ( m = rbaseselector.exec( selector ) ) {
                if ( m[ 1 ] ) { // id
                    res = document.getElementById( m[ 1 ] );
                    if ( res ) {
                        return [ res ];
                    } else {
                        return [];
                    }
                } else if ( m[ 2 ] ) {  // class
                    // return node.getElementsByClassName( m[ 2 ] );
                    return getByClassName( m[ 2 ], node );
                } else if ( m[ 3 ] ) {
                    return node.getElementsByTagName( m[ 3 ] );
                } else if ( m[ 4 ] ) {
                    return node.getElementsByTagName( m[ 4 ] );
                }
            }
            return [];
        }


        function select2 ( selector, results ) {

            results = results || [];

            var selectors = selector.split( ' ' );

            // ??? 'div p .c'

            var arr = [], node = [ document ];


            for ( var j = 0; j < selectors.length; j++ ) {
                for ( var i = 0; i < node.length; i++ ) {
                    push.apply( arr, basicSelect( selectors[ j ], node[ i ] ));
                }
                node = arr;
                arr = [];
            }

            push.apply( results, node );
            return results;

        }

        function select ( selector, results ) {
            results = results || [];
            var m, temp, selectors, i, subselector;

            if ( typeof selector != 'string' ) return results;

            // ?????????????????, ????????????????
            // ?????§Ø? qsa ??????
            // ????? ??????? ??????
            if ( support.qsa ) {
                push.apply( results, document.querySelectorAll( selector ) );
            } else {
                // ????????????????????
                selectors = selector.split( ',' );
                // ???
                for ( i = 0; i < selectors.length; i++ ) {
                    subselector = myTrim( selectors[ i ] );
                    // ?????????? ???? subselector
                    if ( rbaseselector.test( subselector ) ) {
                        // ?????????
                        push.apply( results, basicSelect( subselector ) );
                    } else {
                        // select2 ????
                        select2( subselector, results );
                    }
                }
            }
            // ???? result
            return unique( results );
        }


        return select;
    })();
    wxd.select = select;
/////////////////////////////////select END////////////////////////////////////////////////
    // DOM?????????
    // ??????????? DOM ????
    var parseHTML = (function(){
        // ?????????????dom???????
        var div = document.createElement('div');
        function  parseHTML (html) {
            // ???????dom??
            div.innerHTML = html;
            // ??????????dom????????
            var res = [];
            // ???dom??,????????res ?????????
            for (var i = 0; i < div.childNodes.length; i++) {
                res.push(div.childNodes[i]);
            }
            // ????: div??????????,??????????
            // ????:
            /////////////////////////DEMO/////////////////////////
            //  var a = (function() {
            //      var b = 0;
            //      function c() {
            //           var d = 0;
            //          console.log("d?"+d);
            //          var d = ++b;
            //          var e=0;
            //          e++;
            //          console.log("d??b??????"+d);
            //          console.log("e?"+e);
            //      }
            //       return c;
            //  })();
            //  // a ??????§Ü???  ???????c
            //  // a() -> c()
            //  a();// ?????????0 1 1
            //  a();// ?????????0 2 1
            //  a();// ?????????0 3 1
            ///////////////////////////???/////////////////////////
            //  1. ????a??????,????????????????????b=0,???????????????????c
            //  2. a?????????????????c(??????c?????????????????????????????????????)
            //  3. b?????c????????????,????a???????????????????????????b,?????b????????????????c????????????
            //  4. c??????,????a?????c?????????????????,????b?????????a???????????,??d??e?????????
            //  5. ????????a????§Ó????????????c????,???c???????????????????????,????????????,
            //  ?????c???????????????????????
            //  6. ???????????c?????,b????????a?????????????,?????????????????????
            ///////////////////////////END/////////////////////////
            div.innerHTML = '';
            return res;
        }
        return parseHTML;
    })();

    itcast.fn.appendTo = function ( dom ) {
        for ( var i = 0; i < this.length; i++ ) {
            dom.appendChild( this[ i ] );
        }

    };

    window.wxd = window.I = wxd;
})(window);
